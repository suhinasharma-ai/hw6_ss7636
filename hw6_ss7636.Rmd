---
title: "hw6_ss7636"
output: html_document
date: "2025-11-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(modelr)
```

## Question 1

```{r}
homicide = 
 read_csv("homicide-data.csv", na = c("NA",".", "")) |> 
  janitor :: clean_names() 
homicide
```

```{r}
homicide_city_state = 
  homicide |> 
  mutate(
    city_state = paste(city, state, sep = ", ")
  ) |> 
  mutate(
    unsolved = disposition %in% c("Closed without arrest", "Open/No arrest")
  ) |> 
  mutate(solved_bin = ifelse(unsolved == TRUE, 0, 1)) |> 
  filter(!(city_state %in% c("Dallas, TX",
                             "Phoenix, AZ",
                             "Kansas City, MO",
                             "Tulsa, AL"))) |> 
  filter(victim_race %in% c("White", "Black")) |> 
  mutate(victim_age = as.numeric(victim_age)) 
  
homicide_city_state
```

```{r}
baltimore = homicide_city_state |> 
  filter(city_state == "Baltimore, MD")


fit = glm(
  solved_bin ~ victim_age + victim_sex + victim_race, data = baltimore,  family = binomial(link = "logit")
)
tidy_fit = broom::tidy(fit, conf.int = TRUE, exponentiate = TRUE)

tidy_fit
```
```{r}
tidy_fit |> 
  filter(term == "victim_sexMale")
```
The adjusted odds ratio for a homicide being solved comparing male to female victims, holding age and race constant, was OR = 0.426. The confidence interval is (0.324, 0.558).

```{r}
city_models = homicide_city_state |> 
  group_by(city_state) |> 
  nest() |> 
  mutate(
    fit = map(data, ~ glm(
      solved_bin ~ victim_age + victim_sex + victim_race,
      data = .x,
      family = binomial(link = "logit")
    )),
    tidy_fit = map(fit, ~ broom::tidy(.x, conf.int = TRUE, exponentiate = TRUE))
  ) |> 
  select(city_state, tidy_fit) |> 
  unnest(tidy_fit) |> 
  filter(term == "victim_sexMale")  

city_models
```

```{r city_models_plot, fig.height=10, fig.width=10}
city_models_plot = ggplot(city_models |> 
         mutate(city_state = fct_reorder(city_state, estimate)),
       aes(x = city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  labs(
    title = "Adjusted Odds Ratio (Male vs Female) of Solved Homicides by City",
    x = "City",
    y = "Adjusted Odds Ratio (Male vs Female)",
    caption = "OR < 1 → Male victims less likely to have case solved\nOR > 1 → Male victims more likely to have case solved"
  ) 

city_models_plot
```

The plot shows the odds that a homicide is solved for male vs female victims, holding age and race constant for each city and state. Many cities and states have the OR < 1, meaning male victims are less likely to have their cases solved. Notable cities would be Baton Rouge, LA, Cincinnati, OH, Long Beach, CA, New York, NY, and San Diego, CA. A few cities have OR = 1, such as Atlanta, GA and Nashville, TN. Very few cities have OR > 1. Some include Alburquerque, NM, Fresno, CA, and Stockton, CA. 

## Question 2

```{r}
library(p8105.datasets)
data("weather_df")

weather_df
```

```{r}
fit0 = lm(tmax ~ tmin + prcp, data = weather_df)
broom::glance(fit0)
broom::tidy(fit0)


B = 5000

boot_results = map_dfr(1:B, function(i) {
  boot_sample = weather_df |>  sample_frac(replace = TRUE)

  fit = lm(tmax ~ tmin + prcp, data = boot_sample)
  r2 = broom::glance(fit)$r.squared
  coefs = broom::tidy(fit)

  beta_tmin = coefs$estimate[coefs$term == "tmin"]
  beta_prcp = coefs$estimate[coefs$term == "prcp"]

  tibble(
    r2 = r2,
    beta_prod = beta_tmin/ beta_prcp
  )
})

boot_results
```

```{r}
ggplot(boot_results, aes(x = r2)) +
  geom_histogram(bins = 40, color = "white") +
  labs(title = "Bootstrap Distribution of R-squared",
       x = "R-squared",
       y = "Frequency") +
  theme_minimal()

ggplot(boot_results, aes(x = beta_prod)) +
  geom_histogram(bins = 40, color = "white") +
  labs(title = "Bootstrap Distribution of β1/ β2",
       x = "β_tmin / β_prcp",
       y = "Frequency") +
  theme_minimal()
```
The bootstrap distribution of R² roughly symmetric, unimodal and is centered around 0.94. This suggests that the model explains a consistent portion of the variation in tmax. However, the bootstrap distribution of β₁/β₂ is much more skewed to the left.

```{r}

quantile(boot_results$r2, c(0.025, 0.975))
quantile(boot_results$beta_prod, c(0.025, 0.975))
```

## Question 3

```{r}
birthweight = 
 read_csv("birthweight.csv", na = c("NA",".", "")) |> 
  janitor :: clean_names() 
birthweight
```

```{r}
 babies_clean = birthweight |> 
  mutate(
    babysex = factor(babysex, levels = c(1,2), labels = c("Male","Female")),
    malform = factor(malform, levels = c(0,1), labels = c("No","Yes")),
    frace = factor(frace,
                   levels = c(1,2,3,4,8,9),
                   labels = c("White","Black","Asian","PuertoRican","Other","Unknown")),
    mrace = factor(mrace,
                   levels = c(1,2,3,4,8),
                   labels = c("White","Black","Asian","PuertoRican","Other"))
  ) |> 
  mutate(
    parity = as.integer(parity), bwt = as.numeric(bwt), blength = as.numeric(blength), bhead = as.numeric(bhead), gaweeks = as.numeric(gaweeks), ppbmi = as.numeric(ppbmi), ppwt = as.numeric(ppwt), smoken = as.numeric(smoken), momage = as.numeric(momage), wtgain = as.numeric(wtgain)
  ) 

 babies_clean 
  
```

```{r}
proposed_formula = bwt ~ babysex + gaweeks + blength + bhead +
  ppbmi + smoken + parity + momage + wtgain + malform + frace + mrace +
  babysex:gaweeks + babysex:blength

fit_proposed = lm(proposed_formula, data =  babies_clean )

broom::glance(fit_proposed) |> 
  print()
broom::tidy(fit_proposed) |> 
  print()
```

For this model, I wanted to include fetal size (length, head), maturity (gestational age), sex, maternal resources/behavior (BMI, weight gain, smoking), parity and parental race. I also added two interaction terms (sex × gestational age, sex × length) to allow sex differences in growth trajectories and length–weight mapping.

```{r}
diag_df = babies_clean |> 
  add_predictions(fit_proposed, var = "pred") |> 
  add_residuals(fit_proposed, var = "resid")

p_resid = ggplot(diag_df, aes(x = pred, y = resid)) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(title = "Residuals vs Fitted for Proposed Birthweight Model",
       x = "Fitted birthweight (g)",
       y = "Residuals (observed - fitted, g)") +
  theme_minimal()
print(p_resid)
```

```{r}
modA_formula = bwt ~ blength + gaweeks
modB_formula = bwt ~ bhead * blength * babysex

models = list(
  proposed = proposed_formula,
  model_A = modA_formula,
  model_B = modB_formula
)
```


```{r}
set.seed(123)
cv_df = crossv_mc(babies_clean, n = 100)

cv_results = cv_df |> 
  mutate(
    fits = map(train, ~ map(models, lm, data = as.data.frame(.x)))
  )

cv_results = cv_results |> 
  mutate(
    rmse = map2(fits, test, ~ map(.x, function(mod) {
      test_df = as.data.frame(.y)
      pred = predict(mod, newdata = test_df)
      sqrt(mean((test_df$bwt - pred)^2))
    }))
  )

rmse_tidy = cv_results |> 
  select(rmse) |> 
  unnest_wider(rmse) |> 
  pivot_longer(
    cols = everything(),
    names_to = "model",
    values_to = "rmse"
  )

rmse_summary = rmse_tidy |> 
  group_by(model) |> 
  summarize(
    mean_RMSE = mean(rmse),
    sd_RMSE = sd(rmse),
    .groups = "drop"
  )

rmse_summary

```

```{r}
ggplot(rmse_tidy, aes(x = model, y = rmse)) +
  geom_violin(trim = FALSE, color = "black") +  
  theme_minimal() +
  labs(
    title = "Cross-Validated RMSE for Birthweight Models",
    x = "Model",
    y = "RMSE"
  )
```

I compared three models predicting birthweight using cross-validation and evaluated their prediction errors using RMSE. The model including head circumference, length, sex, and all their interactions had the lowest average RMSE (288 g), indicating the best predictive accuracy and stability. My proposed model, which incorporates fetal size, gestational age, sex, and maternal factors such as BMI, smoking, parity, and race, performed well with an average RMSE of 327 g. Although it was more accurate than the simplest model with only length and gestational age (RMSE ≈ 331 g), it did not outperform the full interaction model. 
